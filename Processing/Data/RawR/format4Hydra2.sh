#! /usr/bin/env bash

# Author:PiM				         Date:11 Apr. 2016
##################################################################
#        REFORMAT LOAD CELL DATA FOR TRANSFER TO HYDRA 2         #
##################################################################
# NOTES:                                                         #
# - INPUT: Compiled Frequency data for each year                 #
# - LOOP through each year and EXTRACT time and data for each    #
#   load cell and each year.                                     #
# - Reformat time from "%Y,%j,%H%M" to "%Y%m%d/%H%M"             #
# - Remove empty lines for each load cell                        #
# - Change NaN values from -99999 to -9999                       #
#                                                                #
# Last Update: 12 Apr. 2016                                      #
# - 2016-04-02: Replace individual load cell codes by a loop     #
#               Change output directory from Sample to Hydra2    #
##################################################################


# Define the Path and Directories to analyse
path='/Users/PiM/Desktop/NVE_work/Processing/Data/Raw'
dir='../Hydra2'

cd $path
[ ! -d $dir ] && ( mkdir $dir )

# LOOP THROUGH THE YEARS
for YEAR in {1992..2013}
do 

# REFORMAT THE DATE TO FIT HYDRA2 
## COMMENTED BECAUSE OF MANUAL EDITS OF THE DATE FILES 
## (SEE AT THE END OF THIS FILE)
#    awk -F, '{print "date -j -v +"$2-1"d -f \"%Y-%m-%d %H%M\" \""$1"-01-01 "$3"\" +%Y%m%d/%H%M"}' LC_$YEAR.csv | bash |  awk 'BEGIN{print "Date"}1' > date_$YEAR.dat

# EXTRACT LOAD CELL DATA
    for LCname in LC6 LC1e LC4 LC2a LC97_2 LC97_1 LC7 LC2b LC01
    do 
    # Assign column of each load cell
	[ $LCname == "LC6" ]    &&   (( col=4  ))
	[ $LCname == "LC1e" ]   &&   (( col=5  ))
	[ $LCname == "LC4" ]    &&   (( col=6  ))
	[ $LCname == "LC2a" ]   &&   (( col=7  ))
	[ $LCname == "LC97_2" ] &&   (( col=8  ))
	[ $LCname == "LC97_1" ] &&   (( col=9  ))
	[ $LCname == "LC7" ]    &&   (( col=10 ))
	[ $LCname == "LC2b" ]   &&   (( col=11 ))
	[ $LCname == "LC01" ]   &&   (( col=12 ))

	echo "$YEAR: $LCname"

# EXTRACT LOAD CELL DATA INDIVIDUALLY AND MERGE WITHE DATE 
# (After removing empty lines and changing -99999 to -9999)
	awk -F, -v tmp=$col '{print $tmp}' LC_$YEAR.csv > ${LCname}_$YEAR.dat

	paste date_$YEAR.dat ${LCname}_$YEAR.dat | awk -F'\t' '$2!=""' | sed 's/-99999/-9999/g' > $dir/${LCname}_$YEAR.dat 

        # Add Carriage return for use in Windows
	perl -pi -e 's/\r\n|\n|\r/\r\n/g' $dir/${LCname}_$YEAR.dat 

	rm ${LCname}_$YEAR.dat 
    done

#    rm date_$YEAR.dat
done


## I HAVE EDITED MANUALLY every year DATE/TIME
# For some unkown reasons, thehour 02:00 is recorded as 03:00.
# I correct that manually
# !!!! SOLVED !!!!: Eva Klausen, NVE told me that:
# it is due to THE TIME CHANGE from WINTER TIME TO SUMMER TIME!!


#for year in {1992..2013};do echo "--- $year ---"; awk 'seen[$1]++' LC6_$year.dat; echo "---";done 
#--- 1992 ---
#---
#--- 1993 ---
#19930328/0300	1.5538
#19930328/0315	1.5543
#19930328/0330	1.5547
#19930328/0345	1.555
#---
#--- 1994 ---
#19940327/0300	1.7283
#19940327/0315	1.7283
#19940327/0330	1.7284
#19940327/0345	1.7283
#---
#--- 1995 ---
#19950326/0301	1.8059
#19950326/0316	1.8059
#19950326/0331	1.8059
#19950326/0346	1.8059
#---
#--- 1996 ---
#---
#--- 1997 ---
#19970330/0300	1.8438
#19970330/0315	1.8438
#19970330/0330	1.8439
#19970330/0345	1.8439
#---
#--- 1998 ---
#19980329/0301	1.8337
#19980329/0316	1.8337
#19980329/0331	1.8337
#19980329/0346	1.8338
#---
#--- 1999 ---
#19990328/0300	1.8196
#19990328/0320	1.8196
#19990328/0340	1.8196
#---
#--- 2000 --- #(in the file, Took the first one as 02:00, third one at 02:15) 
#20000326/0300	1.8249
#20000326/0315	1.82500122070312
#20000326/0330	1.82500122070312
#20000326/0345	1.8249
#20000327/0300	1.8246 
#20000327/0315	1.8247
#20000327/0330	1.8246
#20000327/0345	1.8246
#---
#--- 2001 ---
#20010325/0301	1.8073
#20010325/0303	1.8073
#20010325/0305	1.8073
#20010325/0307	1.8073
#20010325/0309	1.8073
#20010325/0311	1.8073
#20010325/0313	1.8073
#20010325/0315	1.8073
#20010325/0317	1.8073
#20010325/0319	1.8074
#20010325/0321	1.8073
#20010325/0323	1.8074
#20010325/0325	1.8074
#20010325/0327	1.8074
#20010325/0329	1.8074
#20010325/0331	1.8074
#20010325/0333	1.8074
#20010325/0335	1.8074
#20010325/0337	1.8074
#20010325/0339	1.8074
#20010325/0341	1.8074
#20010325/0343	1.8074
#20010325/0345	1.8074
#20010325/0347	1.8074
#20010325/0349	1.8074
#20010325/0351	1.8074
#20010325/0353	1.8073
#20010325/0355	1.8073
#20010325/0357	1.8073
#20010325/0359	1.8073
#---
#--- 2002 ---
#20020331/0301	1.7854
#20020331/0316	1.7855
#20020331/0331	1.7855
#20020331/0346	1.7855
#---
#--- 2003 ---
#20030330/0301	1.8026
#20030330/0316	1.8025
#20030330/0331	1.8025
#20030330/0346	1.8026
#---
#--- 2004 ---
#20040328/0301	1.776
#20040328/0303	1.776
#20040328/0305	1.776
#20040328/0307	1.776
#20040328/0309	1.776
#20040328/0311	1.776
#20040328/0313	1.776
#20040328/0315	1.776
#20040328/0317	1.776
#20040328/0319	1.776
#20040328/0321	1.776
#20040328/0323	1.776
#20040328/0325	1.776
#20040328/0327	1.776
#20040328/0329	1.776
#20040328/0331	1.776
#20040328/0333	1.776
#20040328/0335	1.776
#20040328/0337	1.776
#20040328/0339	1.776
#20040328/0341	1.776
#20040328/0343	1.776
#20040328/0345	1.776
#20040328/0347	1.776
#20040328/0349	1.776
#20040328/0351	1.7761
#20040328/0353	1.776
#20040328/0355	1.7761
#20040328/0357	1.7761
#20040328/0359	1.7761
#---
#--- 2005 ---
#20050327/0301	1.8209
#20050327/0316	1.8208
#20050327/0331	1.8206
#20050327/0346	1.8207
#---
#--- 2006 ---
#20060326/0301	1.7346
#20060326/0316	1.7347
#20060326/0331	1.7346
#20060326/0346	1.7345
#---
#--- 2007 ---
#---
#--- 2008 ---
#20080330/0301	1.7882
#20080330/0316	1.7881
#20080330/0331	1.7881
#20080330/0346	1.7881
#---
#--- 2009 ---
#20090329/0301	1.7954
#20090329/0316	1.7953
#20090329/0331	1.7952
#20090329/0346	1.7952
#---
#--- 2010 ---
#20100328/0301	1.7915
#20100328/0303	1.7914
#20100328/0305	1.7915
#20100328/0307	1.7915
#20100328/0309	1.7915
#20100328/0311	1.7915
#20100328/0313	1.7915
#20100328/0315	1.7915
#20100328/0317	1.7915
#20100328/0319	1.7915
#20100328/0321	1.7915
#20100328/0323	1.7915
#20100328/0325	1.7915
#20100328/0327	1.7915
#20100328/0329	1.7915
#20100328/0331	1.7915
#20100328/0333	1.7915
#20100328/0335	1.7915
#20100328/0337	1.7916
#20100328/0339	1.7915
#20100328/0341	1.7916
#20100328/0343	1.7916
#20100328/0345	1.7916
#20100328/0347	1.7916
#20100328/0349	1.7916
#20100328/0351	1.7916
#20100328/0353	1.7917
#20100328/0355	1.7917
#20100328/0357	1.7917
#20100328/0359	1.7917
#---
#--- 2011 ---
#20110327/0302	-9999
#20110327/0317	-9999
#20110327/0332	-9999
#20110327/0347	-9999
#---
#--- 2012 ---
#20120325/0301	1.7909
#20120325/0303	1.7909
#20120325/0305	1.7909
#20120325/0307	1.7909
#20120325/0309	1.7909
#20120325/0311	1.7909
#20120325/0313	1.7909
#20120325/0315	1.7909
#20120325/0317	1.7909
#20120325/0319	1.7909
#20120325/0321	1.7909
#20120325/0323	1.7909
#20120325/0325	1.7909
#20120325/0327	1.7909
#20120325/0329	1.7909
#20120325/0331	1.791
#20120325/0333	1.791
#20120325/0335	1.7909
#20120325/0337	1.791
#20120325/0339	1.791
#20120325/0341	1.791
#20120325/0343	1.7909
#20120325/0345	1.7909
#20120325/0347	1.7909
#20120325/0349	1.7909
#20120325/0351	1.791
#20120325/0353	1.791
#20120325/0355	1.7909
#20120325/0357	1.7909
#20120325/0359	1.791
#---
#--- 2013 ---
#20130331/0301	1.7961
#20130331/0303	1.7963
#20130331/0305	1.7962
#20130331/0307	1.7962
#20130331/0309	1.7964
#20130331/0311	1.7962
#20130331/0313	1.7963
#20130331/0315	1.7963
#20130331/0317	1.7964
#20130331/0319	1.7964
#20130331/0321	1.7964
#20130331/0323	1.7962
#20130331/0325	1.7964
#20130331/0327	1.7963
#20130331/0329	1.7962
#20130331/0331	1.7962
#20130331/0333	1.7963
#20130331/0335	1.7963
#20130331/0337	1.7962
#20130331/0339	1.7963
#20130331/0341	1.7963
#20130331/0343	1.7963
#20130331/0345	1.7964
#20130331/0347	1.7961
#20130331/0349	1.7962
#20130331/0351	1.7964
#20130331/0353	1.7963
#20130331/0355	1.7962
#20130331/0357	1.7964
#20130331/0359	1.7962
#---
